@model HutechITEvent.Models.Event
@inject Microsoft.AspNetCore.Identity.UserManager<HutechITEvent.Models.User> UserManager
@inject HutechITEvent.Data.ApplicationDbContext DbContext
@{
    ViewData["Title"] = Model.Title;
}

<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-action="Index">Sự kiện</a></li>
            <li class="breadcrumb-item active">@Model.Title</li>
        </ol>   
    </nav>

    <div class="row">
        <div class="col-md-8">
            @if (!string.IsNullOrEmpty(Model.ThumbnailUrl))
            {
                <img src="@Model.ThumbnailUrl" class="img-fluid rounded mb-3" alt="@Model.Title">
            }

            <h1>@Model.Title</h1>

            <div class="mb-3">
                <span class="badge bg-@(Model.Status == EventStatus.Published ? "success" : Model.Status == EventStatus.Ongoing ? "primary" : "secondary") me-2">
                    @Model.Status.ToString()
                </span>
                <span class="badge bg-info">@Model.Category?.Name</span>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Thông tin sự kiện</h5>
                    <hr />
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <i class="bi bi-calendar-event text-primary"></i>
                            <strong>Thời gian bắt đầu:</strong><br />
                            <span class="ms-4">@Model.StartDate.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <i class="bi bi-calendar-check text-danger"></i>
                            <strong>Thời gian kết thúc:</strong><br />
                            <span class="ms-4">@Model.EndDate.ToString("dd/MM/yyyy HH:mm")</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <i class="bi bi-geo-alt text-success"></i>
                            <strong>Địa điểm:</strong><br />
                            <span class="ms-4">@Model.Location</span>
                        </div>
                        <div class="col-md-6 mb-2">
                            <i class="bi bi-people text-warning"></i>
                            <strong>Số lượng:</strong><br />
                            <span class="ms-4">@Model.Registrations.Count / @Model.MaxParticipants người</span>
                        </div>
                        @if (Model.Organizer != null)
                        {
                            <div class="col-md-12 mb-2">
                                <i class="bi bi-person-badge text-info"></i>
                                <strong>Người tổ chức:</strong>
                                <span class="ms-2">@Model.Organizer.FullName</span>
                            </div>
                        }
                    </div>
                </div>
            </div>

            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Mô tả</h5>
                    <hr />
                    <p style="white-space: pre-line;">@Model.Description</p>
                </div>
            </div>

            @if (Model.Schedules.Any())
            {
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Lịch trình</h5>
                        <hr />
                        <div class="list-group">
                            @foreach (var schedule in Model.Schedules.OrderBy(s => s.StartTime))
                            {
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">@schedule.Title</h6>
                                        <small>@schedule.StartTime.ToString("HH:mm") - @schedule.EndTime.ToString("HH:mm")</small>
                                    </div>
                                    @if (!string.IsNullOrEmpty(schedule.Speaker))
                                    {
                                        <p class="mb-1"><strong>Diễn giả:</strong> @schedule.Speaker</p>
                                    }
                                    @if (!string.IsNullOrEmpty(schedule.Location))
                                    {
                                        <small class="text-muted">Địa điểm: @schedule.Location</small>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="col-md-4">
            <div class="card sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h5 class="card-title">Đăng ký tham gia</h5>
                    <hr />
                    
                    @if (TempData["Success"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show">
                            @TempData["Success"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show">
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    
                    @if (Model.Registrations.Count >= Model.MaxParticipants)
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> Sự kiện đã đủ số lượng đăng ký!
                        </div>
                    }
                    else if (User.Identity?.IsAuthenticated == true)
                    {
                        @if (User.IsInRole("Student"))
                        {
                            var user = await UserManager.GetUserAsync(User);
                            var student = DbContext.Students.FirstOrDefault(s => s.UserId == user.Id);
                            var isRegistered = student != null && Model.Registrations.Any(r => r.StudentId == student.Id);
                            
                            @if (isRegistered)
                            {
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle"></i> Bạn đã đăng ký sự kiện này!
                                </div>
                                <form asp-action="Unregister" method="post">
                                    <input type="hidden" name="eventId" value="@Model.Id" />
                                    <button type="submit" class="btn btn-outline-danger w-100 mb-2" onclick="return confirm('Bạn có chắc muốn hủy đăng ký?')">
                                        <i class="bi bi-x-circle"></i> Hủy đăng ký
                                    </button>
                                </form>
                            }
                            else
                            {
                                <form asp-action="Register" method="post">
                                    <input type="hidden" name="eventId" value="@Model.Id" />
                                    <button type="submit" class="btn btn-success w-100 mb-2">
                                        <i class="bi bi-check-circle"></i> Đăng ký ngay
                                    </button>
                                </form>
                            }
                        }
                        <a asp-action="Index" class="btn btn-outline-secondary w-100">
                            <i class="bi bi-arrow-left"></i> Quay lại
                        </a>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            <a asp-controller="Account" asp-action="Login" asp-route-returnUrl="@Context.Request.Path">Đăng nhập</a> để đăng ký sự kiện.
                        </div>
                    }

                    @if (User.IsInRole("Admin") || (Model.OrganizerId == int.Parse(User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value ?? "0")))
                    {
                        <hr />
                        <h6>Quản lý</h6>
                        <a asp-action="Registrations" asp-route-id="@Model.Id" class="btn btn-info w-100 mb-2">
                            <i class="bi bi-people"></i> Danh sách đăng ký (@Model.Registrations.Count)
                        </a>
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning w-100 mb-2">
                            <i class="bi bi-pencil"></i> Sửa
                        </a>
                        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger w-100">
                            <i class="bi bi-trash"></i> Xóa
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
